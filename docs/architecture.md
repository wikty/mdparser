## 原则

* 首先要保证支持 Markdown 基础语法
* 模块化，容易对 Markdown 语法扩展，后期考虑支持 GitHub Flavored Markdown 等流行的扩展语法
* 实现多线程/多进程模式，以加快解析速度
* 配置灵活，允许以配置文件或者命令行参数的方式来控制解析过程

## Markdown 基础语法分析

Markdown 文档由块级元素和行内元素构成，块级元素中可能会嵌套有块级元素，而块级元素中又可能包含了行内元素，同时行内元素又可能嵌套了行内元素。如果为文档引入一个根节点，再结合块元素和行内元素这种嵌套关系，可以将文档看成是树状结构。

### 语法概况

块级元素主要有：

* HTML 块级标记的代码片段，不解析内容
* 文本段落，也即一个或多个连续的文本行
* 标题，也即一个文本行
* 块引用，一个或多个段落、块引用、标题、列表以及代码块等
* 列表，列表项可以是一个或多个段落、块引用、标题、列表以及代码块等
* 代码块，缩进不少于 4 个空格的多个段落，除了转义 `&><` 外，不解析内容
* 水平线，仅由水平线标记符构成

行内元素主要有：

* HTML 行内标记的代码片段，解析内容
* HTML 特殊字符，即 `&><`，需要进行实体转义
* 超链接，行内链接、引用链接以及快捷链接
* 图片，行内图片和引用图片
* 强调，允许其它行内元素的嵌套
* 强制换行
* 行内代码，除了转义 `&><` 外，不解析内容
* 转义符，利用 `\` 来转义 Markdown 中所有元字符

### 语法细节

#### 块级元素

HTML 块级标记

* 用途

  插入 Markdown 无法表达的 HTML [块级语义标记][ref1]

* 定界符

  起始定界符和终止定界符分别是 HTML 块级标记的开始和结束标记

* 外部定界

  从可读性上来说，应该用空行跟前后其它内容隔开，起始和终止定界符单独成行且位于行首；不过从解析上来说，应该宽松对待，起始和终止定界符不一定要单独成行，并且它们前面可以有少于四个的空格，并且在终止定界符之后也允许出现内容

* 定界符解析

  保持原始 HTML 标记不变

* 内容解析

  内容保持原样输出，不解析其中的任何 Markdown 语法，也不进行 HTML 实体转义

* 异常

  HTML 标记是成对出现的，当插入的 HTML 代码片段发生起始或终止标记缺失时，该如何处理？


文本段落

- 用途

  文档内容的主体

- 定界符

  以除 Mardown 元字符外的字符开头的一个或多个连续的文本行，并且缩进少于 4 个空格

- 外部定界

  从可读性上来说，应该用空行跟前后其它内容隔开，并且不要缩进段落；不过从解析上来说，应该宽松对待，文本行可以缩进少于 4 个空格，空行可以含有空格和制表符，而且没有歧义的情况下段落可以不跟前后内容用空白行隔开

- 定界符解析

  解析为 `<p></p>`

- 内容解析

  段落由若干文本行组成，解析文本行等价于解析其中的行内元素

- 异常

  紧跟在 HTML 块级标记后面的段落该如何处理？

标题

- 用途

  文档划分小节，构建层级结构

- 定界符

  以 1~6 个 `#` 开头的文本行或者文本行的下一行是若干 `=` 或 `-`

- 外部定界

  从可读性上来说，应该用空行跟前后其它内容隔开；不过从解析上来说，应该宽松对待，没有歧义的情况下可以不跟前后内容用空行隔开

- 定界符解析

  解析为 `<h1></h1>`, `<h2></h2>` 等

- 内容解析

  标题内容是一个文本行，解析文本行等价于解析其中的行内元素

- 异常

  无

块引用

- 用途

  引用其它来源的内容片段

- 定界符

  以 `>` 开始的段落，段落中首行必须以 `>` 作为开头，剩余行可选。

- 外部定界

  应该用空行跟前后其它内容隔开

- 定界符解析

  解析为 `<blockquote></blockquote>`

- 内容解析

  内容由一个或多个段落、块引用、标题、列表以及代码块等组成

- 异常

  无

列表

- 用途

  列举一系列项目（有序和无序）

- 定界符

  以 `-`, `+`, `*`, `1.` 等开头的列标记，加空格或制表符。

- 外部定界

  应该用空行跟前后其它内容隔开

- 定界符解析

  解析为 `<ol></ol>` 或 `<ul></ul>`

- 内容解析

  **列表项**的内容由一个或多个段落、块引用、标题、列表以及代码块等组成。段落支持悬挂式缩进。多个段落，除了首段外，其余段落要缩进四个空格或一个制表符，而且这些段落可以仅缩进首行或者缩进段落的所有行。块引用需要缩进四个空格或一个制表符。列表需要缩进四个空格或一个制表符。代码块需要缩进八个空格或一个制表符。空白行分隔的列表项用 `<li><p></p></li>` 包裹内容，紧邻列表项则用 `<li>` 包裹内容。有序列表中列表项的输出顺序跟数字序标无关，跟书写顺序相关。

- 异常

  无

代码块

- 用途

  使得像程序代码这样的文本按照字面格式显示

- 定界符

  缩进 4 个以上空格

- 外部定界

  应该用空行跟前后其它内容隔开

- 定界符解析

  解析为 `<pre><code></code></pre>`

- 内容解析

  不解析 Markdown，对 HTML 特殊字符 `&><` 转义

- 异常

  无

#### 行内元素

HTML 行内标记

HTML 特殊字符

超链接

图片

强调

行内代码

转义符

#### 抽象元素

文本行（不含换行符的一行字符），文本行中可能含有如下几种内容：

- 普通字符串不做任何处理
- 文本行结尾的换行符不做任何处理
- 使用 `\` 转义的 Markdown 元字符
- Markdown 行内语法
- HTML 行内元素：如 `<span>`, `<cite>`, `<del>` 等，行内元素中包含的 Markdown 语法也会被解析
- HTML 实体以及引起歧义需要转义的字符 `&` 和 `<`
- 文本行结尾的两个连续空格将被解析为 `<br/>`
- ​


## 组件

* Workflow Pipeline Object / WPO
* Format Processor Object / FPO
* Markdown Abstract Document Object / MADO
* Markdown Syntax Instance Object / MSIO
* Stack Parser Object / SPO
* Input & Output Converter Object / IOCO

## 解析流程

1. IOCO loads a Markdown document as an instance of MADO.
2. do somethine
3. Create an instance of WPO and some instances of FPO. Then register those FPOs into the WPO instance.
4. Run the pipeline of WPO while the underlying document object is formatted.
5. IOCO dumps the MADO instance as a HTML document.

## 扩展语法

两个想法：

* 实现 Github Markdown 等常见扩展
* 支持通过编辑规则来扩展语法




[ref1]: https://developer.mozilla.org/zh-CN/docs/Web/HTML/Block-level_elements	"HTML Block Elements"